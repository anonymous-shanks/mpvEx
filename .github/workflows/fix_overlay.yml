name: Standard Build (Top Overlay)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout Code (With Submodules for MPV)
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: recursive

      # 2. Sync with Original Dev (Latest Updates Lene Ke Liye)
      - name: Sync with Upstream
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          target_sync_branch: master
          target_repo_token: ${{ secrets.GITHUB_TOKEN }}
          upstream_sync_repo: marlboro-advance/mpvEx
          upstream_sync_branch: master
          test_mode: false

      # 3. Setup Java & NDK
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 4. Hack Build Files (Signing Remove Karna - Zaroori Hai)
      - name: Hack Signing & Configs
        run: |
          echo "Removing Signing Configs..."
          find . -name "build.gradle*" -print0 | xargs -0 -r sed -i 's/signingConfig signingConfigs.release//g'
          find . -name "build.gradle*" -print0 | xargs -0 -r sed -i 's/signingConfig signingConfigs.debug//g'
          
          # Dummy Keystore & Google Services (Crash Fix)
          echo "keyAlias=androiddebugkey" > keystore.properties
          echo "storeFile=../debug.keystore" >> keystore.properties
          echo '{"project_info":{"project_number":"0","project_id":"d"},"client":[{"client_info":{"mobilesdk_app_id":"1:0:a:0","android_client_info":{"package_name":"com.dummy"}},"api_key":[{"current_key":"D"}]}]}' > app/google-services.json

      # 5. SAFE OVERLAY PATCH (Center -> TopCenter)
      # Note: Hum padding add nahi kar rahe taaki syntax error na aaye.
      - name: Patch Overlay Position
        run: |
          echo "ðŸ” Searching for Speed/Gesture Overlay files..."
          
          # Hum un files ko target karenge jisme "Speed", "Gesture" ya "Overlay" likha ho
          # Aur jisme "Alignment.Center" use ho raha ho.
          
          grep -lR "Alignment.Center" app/src/main/java | grep -E "Speed|Gesture|Overlay" > targets.txt || true
          
          if [ -s targets.txt ]; then
            echo "âœ… Target Files Found:"
            cat targets.txt
            
            while IFS= read -r file; do
              echo "ðŸ”§ Moving Alignment to Top in: $file"
              # Sirf Alignment change kar rahe hain. No Padding = No Syntax Error.
              sed -i 's/Alignment.Center/Alignment.TopCenter/g' "$file"
            done < targets.txt
            
            echo "ðŸŽ‰ Patch Applied Successfully!"
          else
            echo "âš ï¸ Specific files not found. Trying broad search for GestureHandler..."
            # Fallback: Agar file name match na kare, to GestureHandler ko direct target karo
            find app/src/main/java -name "*GestureHandler*" -exec sed -i 's/Alignment.Center/Alignment.TopCenter/g' {} +
          fi

      # 6. BUILD STANDARD VERSION (Non F-Droid)
      # 'assembleStandardDebug' sirf Normal version banayega
      - name: Build Standard Debug APK
        run: |
          chmod +x gradlew
          ./gradlew assembleStandardDebug -x lint

      # 7. UPLOAD (Arm64 Only - Small Size)
      - name: Upload Standard Arm64 APK
        uses: actions/upload-artifact@v4
        with:
          name: mpvEx-Standard-TopOverlay
          # Path me 'standard' folder include kiya hai taaki F-Droid wala na uthaye
          path: app/build/outputs/apk/standard/debug/*arm64-v8a*.apk